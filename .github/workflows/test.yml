name: Deriv-App
on:
  pull_request:
    branches:
    - master
env:
  CACHE_VERSION: ${{ github.sha }}
  COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
  DATADOG_CLIENT_TOKEN_LOGS: ${{ secrets.DATADOG_CLIENT_TOKEN_LOGS }}
  DATADOG_SESSION_REPLAY_SAMPLE_RATE: ${{ secrets.DATADOG_SESSION_REPLAY_SAMPLE_RATE }}
  DATADOG_SESSION_SAMPLE_RATE: ${{ secrets.DATADOG_SESSION_SAMPLE_RATE }}
  DATADOG_SESSION_SAMPLE_RATE_LOGS: ${{ secrets.DATADOG_SESSION_SAMPLE_RATE_LOGS }}
  GD_API_KEY: ${{ secrets.GD_API_KEY }}
  GD_APP_ID: ${{ secrets.GD_APP_ID }}
  GD_CLIENT_ID: ${{ secrets.GD_CLIENT_ID }}
  JEST_MAX_WORKERS: 8
  RUDDERSTACK_PRODUCTION_KEY: ${{ secrets.RUDDERSTACK_PRODUCTION_KEY }}
  RUDDERSTACK_STAGING_KEY: ${{ secrets.RUDDERSTACK_STAGING_KEY }}
  RUDDERSTACK_URL: ${{ secrets.RUDDERSTACK_URL }}
jobs:
  build_and_test:
    name: Build And Test

#     if: # GitHub does not currently support regular expressions inside if conditions
# #         github.ref != 'refs/heads/master' && github.ref != 'refs/heads/gh-pages' && github.ref != 'refs/tags//.*/'
    runs-on: Runner_16cores
    container:
      image: node:18.16.0
    steps:
    - uses: actions/checkout@v3.6.0
    - name: Checkout Repository
      uses: "./.github/actions/git_checkout_from_cache"
    - name: Install dependencies
      uses: "./.github/actions/npm_install_from_cache"
    - name: Build
      uses: "./.github/actions/build"
    - name: Check TypeScript for @deriv/api
      run: npx tsc --project packages/api/tsconfig.json -noEmit
    - name: Check TypeScript for @deriv/hooks
      run: npx tsc --project packages/hooks/tsconfig.json -noEmit
    - name: Check TypeScript for @deriv/utils
      run: npx tsc --project packages/utils/tsconfig.json -noEmit
    - name: Check TypeScript for @deriv/analytics
      run: npx tsc --project packages/analytics/tsconfig.json -noEmit
    - name: Check TypeScript for @deriv/stores
      run: npx tsc --project packages/stores/tsconfig.json -noEmit
    - name: Check TypeScript and linting for @deriv/wallets
      run: |-
        npx tsc --project packages/wallets/tsconfig.json -noEmit
        npx eslint --fix --config packages/wallets/.eslintrc.js packages/wallets
        npx stylelint packages/wallets/**/*.scss
    - name: Check tests for @deriv/hooks
      run: bash ./scripts/check-tests.sh packages/hooks/src
    - name: Check tests for @deriv/utils
      run: bash ./scripts/check-tests.sh packages/utils/src
    - name: Check tests for @deriv/analytics
      run: bash ./scripts/check-tests.sh packages/analytics/src
    - name: Run tests
      run: npm test
